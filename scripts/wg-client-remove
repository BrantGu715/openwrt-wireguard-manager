#!/bin/sh

NAME="$1"
WG_IF="wg0"
MAP_FILE="/etc/wireguard/clients/clients.map"
CLIENT_DIR="/etc/wireguard/clients"

[ -z "$NAME" ] && {
    echo "ç”¨æ³•: wg-client-remove <client_name>"
    exit 1
}

# 1. ä» clients.map ä¸­è·å– public_key
PUBKEY=$(grep "|$NAME|" "$MAP_FILE" | cut -d'|' -f1)

if [ -z "$PUBKEY" ]; then
    echo "âŒ æœªæ‰¾åˆ°å®¢æˆ·ç«¯: $NAME"
    exit 1
fi

echo "ğŸ—‘ï¸  åˆ é™¤å®¢æˆ·ç«¯: $NAME"
echo "   å…¬é’¥: $PUBKEY"

# 2. åˆ é™¤ network ä¸­å¯¹åº” peer
uci show network | grep -q "$PUBKEY" && {
    IDX=$(uci show network | grep "$PUBKEY" | cut -d. -f2 | cut -d= -f1)
    uci delete network.$IDX
    echo "âœ… å·²ä» network åˆ é™¤ peer"
}

# 3. åˆ é™¤ clients.map è®°å½•
sed -i "\|$PUBKEY|d" "$MAP_FILE"
echo "âœ… å·²ä» clients.map åˆ é™¤"

# 4. åˆ é™¤å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶
rm -f "$CLIENT_DIR/$NAME.conf"
rm -f "$CLIENT_DIR/$NAME.png"

# 5. åº”ç”¨é…ç½®
uci commit network
/etc/init.d/network reload

echo "ğŸ¯ å®¢æˆ·ç«¯ $NAME å·²å®Œå…¨ç§»é™¤"
